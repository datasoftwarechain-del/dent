---
import AppLayout from '@/layouts/AppLayout.astro';
import { supabaseAdmin } from '@/server/db/client';
import { isAdmin } from '@/server/auth/permissions';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}

if (!isAdmin(user)) {
  return new Response('Forbidden', { status: 403 });
}

const { data: leads = [] } = await supabaseAdmin
  .from('leads')
  .select('*')
  .order('createdAt', { ascending: false });
---

<AppLayout title="Leads" description="Leads recolectados desde la landing page" user={user}>
  <div class="mx-auto max-w-4xl">
    <h1 class="text-2xl font-bold text-white">Leads Recolectados</h1>
    <div class="mt-8 overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-700">
        <thead class="bg-slate-800">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-300">Nombre</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-300">Email</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-300">Teléfono</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-300">Fuente</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-300">Mensaje</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-300">Fecha</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-800 bg-slate-900">
          {leads.length === 0 && (
            <tr>
              <td colSpan={6} class="px-6 py-6 text-center text-sm text-slate-400">
                Aún no se registraron leads.
              </td>
            </tr>
          )}
          {leads.map((lead) => (
            <tr>
              <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-white">{lead.name}</td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-slate-300">{lead.email}</td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-slate-300">{lead.phone ?? '-'}</td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-slate-300">{lead.source ?? '-'}</td>
              <td class="px-6 py-4 text-sm text-slate-300">{lead.message ?? '—'}</td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-slate-300">{new Date(lead.createdAt).toLocaleString('es-AR')}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>
</AppLayout>
