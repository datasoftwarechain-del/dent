---
import AppLayout from '@/layouts/AppLayout.astro';
import workTypes from '@/data/work-types.json';
import { supabaseAdmin } from '@/server/db/client';
import { getWorkOrderById } from '@/server/services/work-order-service';
import { normalizeWorkTypeLabelToEnum } from '@/server/auth/permissions';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}

const workOrderId = Astro.params.id!;
const workOrder = await getWorkOrderById(workOrderId, user);
if (!workOrder) {
  return new Response('Orden no encontrada', { status: 404 });
}

const workTypesData = workTypes.trabajos;
const { data: databaseClients = [] } = await supabaseAdmin
  .from('clients')
  .select('id,name')
  .order('name', { ascending: true });

const dueDateValue = workOrder.dueDate
  ? new Date(workOrder.dueDate).toISOString().slice(0, 16)
  : '';
const err = Astro.url.searchParams.get('error');
---

<AppLayout
  title={`Editar ${workOrder.displayCode ?? workOrder.code}`}
  description="Actualiza los datos de la orden"
  user={user}
>
  <div class="mx-auto max-w-3xl rounded-3xl border border-white/10 bg-slate-950/70 p-6 shadow-lg shadow-primary/5">
    <h2 class="text-lg font-semibold text-white">Editar orden</h2>
    <p class="mt-2 text-sm text-slate-400">
      Ajusta los datos de la orden y guarda los cambios. Puedes volver a esta pantalla en cualquier momento.
    </p>
    <form id="work-order-edit-form" method="post" action={`/api/work-orders/${workOrderId}`} class="mt-6 space-y-5">
      <input type="hidden" name="_method" value="PUT" />
      <div class="relative" data-patient-chooser>
        <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
          <span>Paciente</span>
          <input
            id="patientSearch"
            type="text"
            autocomplete="off"
            placeholder="Busca por nombre del paciente"
            value={workOrder.patient?.name ?? ''}
            class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-4 py-3 text-sm text-white focus:border-accent focus:outline-none"
            data-patient-search
          />
        </label>
        <input type="hidden" name="patientId" id="patientIdHidden" value={workOrder.patientId} />
        <p class="mt-1 text-xs text-slate-400">
          Selecciona un paciente existente o escribe un nombre para crear uno nuevo.
        </p>
        <div
          id="patient-suggestions"
          class="absolute inset-x-0 z-20 mt-1 hidden max-h-56 overflow-auto rounded-xl border border-white/10 bg-slate-900/90 text-sm shadow-xl shadow-black/30"
          data-patient-suggestions
        ></div>
      </div>
      <input type="hidden" id="predefinedClientName" name="predefinedClientName" value="" />
      <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
        <span>Fecha estimada de entrega</span>
        <input
          id="dueDate"
          name="dueDate"
          type="datetime-local"
          value={dueDateValue}
          class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-4 py-3 text-sm text-white focus:border-accent focus:outline-none"
        />
      </label>
      <div class="grid grid-cols-1 gap-5 md:grid-cols-2">
        <div>
          <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
            <span>Cliente</span>
            <select
              id="clientId"
              name="clientId"
              class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-4 py-3 text-sm text-white focus:border-accent focus:outline-none"
            >
              <option value="">—</option>
              {databaseClients.map((client) => (
                <option value={client.id} selected={client.id === workOrder.clientId}>
                  {client.name}
                </option>
              ))}
            </select>
          </label>
          <button type="button" id="add-client-btn" class="mt-2 text-sm text-accent hover:underline">+ Agregar Nuevo Cliente</button>
        </div>
      </div>
      <div class="flex flex-col gap-2 text-sm font-medium text-slate-200">
        <span>Tipo de trabajo</span>
        <div class="grid grid-cols-2 gap-4">
          {workTypesData.map((label) => {
            const checked = normalizeWorkTypeLabelToEnum(label) === workOrder.workType;
            return (
              <div class="flex items-center gap-2">
                <input
                  type="radio"
                  name="workType"
                  value={label}
                  id={`workType-${label}`}
                  class="h-4 w-4 text-accent bg-gray-100 border-gray-300 focus:ring-accent"
                  checked={checked ? true : undefined}
                />
                <label for={`workType-${label}`} class="text-sm font-medium text-white cursor-pointer">{label}</label>
              </div>
            );
          })}
        </div>
      </div>
      <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
        <span>Notas</span>
        <textarea
          id="notes"
          name="notes"
          rows={4}
          class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-4 py-3 text-sm text-white focus:border-accent focus:outline-none"
        >{workOrder.notes ?? ''}</textarea>
      </label>
      {err && (
        <p class="mt-3 rounded-xl border border-red-500/20 bg-red-500/10 px-4 py-3 text-sm text-red-300">{err}</p>
      )}
      <button
        type="submit"
        class="w-full rounded-xl bg-accent px-4 py-3 text-sm font-semibold text-white transition hover:bg-accent/90"
      >
        Guardar cambios
      </button>
    </form>
  </div>

  <script is:inline>
    (() => {
      const form = document.getElementById('work-order-edit-form');
      if (!form) return;
      const patientSearch = document.querySelector('[data-patient-search]');
      const patientIdInput = document.getElementById('patientIdHidden');
      const suggestionsBox = document.querySelector('[data-patient-suggestions]');
      const submitBtn = form.querySelector('button[type="submit"]');
      let suggestionAbort = 0;

      const hideSuggestions = () => {
        if (suggestionsBox instanceof HTMLElement) {
          suggestionsBox.innerHTML = '';
          suggestionsBox.classList.add('hidden');
        }
      };

      const applySuggestion = (id, name) => {
        if (patientSearch instanceof HTMLInputElement) {
          patientSearch.value = name;
        }
        if (patientIdInput instanceof HTMLInputElement) {
          patientIdInput.value = id;
        }
        hideSuggestions();
      };

      const renderSuggestions = (items) => {
        if (!(suggestionsBox instanceof HTMLElement)) return;
        suggestionsBox.innerHTML = '';
        if (!items.length) {
          hideSuggestions();
          return;
        }
        items.forEach((item) => {
          const option = document.createElement('button');
          option.type = 'button';
          option.textContent = item.name;
          option.className =
            'block w-full px-4 py-2 text-left text-sm text-white hover:bg-accent/20 focus:bg-accent/30';
          option.addEventListener('click', () => applySuggestion(item.id, item.name));
          suggestionsBox.appendChild(option);
        });
        suggestionsBox.classList.remove('hidden');
      };

      const searchPatients = async (query) => {
        if (query.length < 2) {
          hideSuggestions();
          return;
        }
        const ticket = ++suggestionAbort;
        try {
          const response = await fetch(`/api/patients/search?q=${encodeURIComponent(query)}`);
          if (!response.ok) return;
          if (ticket !== suggestionAbort) return;
          const data = await response.json();
          renderSuggestions(data?.patients ?? []);
        } catch (error) {
          console.error('Patient search failed', error);
        }
      };

      let debounceHandle;
      if (patientSearch instanceof HTMLInputElement && patientIdInput instanceof HTMLInputElement) {
        patientSearch.addEventListener('input', (event) => {
          const target = event.target;
          if (!(target instanceof HTMLInputElement)) return;
          const value = target.value;
          patientIdInput.value = value;
          window.clearTimeout(debounceHandle);
          debounceHandle = window.setTimeout(() => searchPatients(value.trim()), 200);
        });
      }

      document.addEventListener('click', (event) => {
        if (!(event.target instanceof Node)) return;
        if (!event.target.closest('[data-patient-chooser]')) {
          hideSuggestions();
        }
      });

      if (form instanceof HTMLFormElement && submitBtn instanceof HTMLButtonElement) {
        form.addEventListener('submit', () => {
          if (patientIdInput instanceof HTMLInputElement && !patientIdInput.value) {
            if (patientSearch instanceof HTMLInputElement) {
              patientIdInput.value = patientSearch.value.trim();
            }
          }
          submitBtn.setAttribute('disabled', 'true');
          submitBtn.textContent = 'Guardando…';
        });

        const params = new URLSearchParams(window.location.search);
        if (params.has('error')) {
          submitBtn.removeAttribute('disabled');
          submitBtn.textContent = 'Guardar cambios';
        }
      }

      const addClientBtn = document.getElementById('add-client-btn');
      const clientIdSelect = document.getElementById('clientId');
      const predefinedClientInput = document.getElementById('predefinedClientName');

      if (clientIdSelect instanceof HTMLSelectElement && predefinedClientInput instanceof HTMLInputElement) {
        const ensureCustomOption = (label) => {
          const existing = clientIdSelect.querySelector('option[data-custom="true"]');
          if (existing) {
            existing.textContent = label;
            existing.selected = true;
            existing.value = '';
            return existing;
          }
          const option = document.createElement('option');
          option.dataset.custom = 'true';
          option.value = '';
          option.textContent = label;
          option.selected = true;
          clientIdSelect.appendChild(option);
          return option;
        };

        clientIdSelect.addEventListener('change', (event) => {
          const target = event.target;
          if (!(target instanceof HTMLSelectElement)) return;
          const selected = target.selectedOptions[0] ?? null;
          const value = selected?.value.trim() ?? '';
          const isCustom = selected?.dataset.custom === 'true';
          if (value) {
            predefinedClientInput.value = '';
            const existing = clientIdSelect.querySelector('option[data-custom="true"]');
            if (existing) existing.remove();
            return;
          }
          if (!isCustom) {
            predefinedClientInput.value = '';
            const existing = clientIdSelect.querySelector('option[data-custom="true"]');
            if (existing) existing.remove();
          }
        });

        if (addClientBtn instanceof HTMLButtonElement) {
          addClientBtn.addEventListener('click', () => {
            const name = prompt('Ingrese el nombre del nuevo cliente:');
            const trimmed = name ? name.trim() : '';
            if (!trimmed) return;
            predefinedClientInput.value = trimmed;
            ensureCustomOption(trimmed);
          });
        }
      }
    })();
  </script>
</AppLayout>
