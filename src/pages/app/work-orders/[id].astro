---
import AppLayout from '@/layouts/AppLayout.astro';
import ModelViewer from '@/components/ModelViewer.astro';
import { getWorkOrderById } from '@/server/services/work-order-service';
import { canSeePrices, canUploadWorkOrderFiles, isAdmin } from '@/server/auth/permissions';
import { supabaseAdmin } from '@/server/db/client';
import workTypes from '@/data/work-types.json';
import clients from '@/data/clients.json';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}

const userIsAdmin = isAdmin(user);

const workOrderId = Astro.params.id!;
const isNew = workOrderId === 'new';

const showPrice = canSeePrices(user);
const allowFileUpload = canUploadWorkOrderFiles(user);
const workTypesData = workTypes.trabajos;
const predefinedClients = clients.clientes;

// Fetch actual clients from database for the dropdown
const { data: databaseClients = [] } = await supabaseAdmin
  .from('clients')
  .select('id,name')
  .order('name', { ascending: true });
const statusNames: Record<string, string> = {
  CREATED: 'Creada',
  IN_PROGRESS: 'En progreso',
  READY: 'Lista',
  DELIVERED: 'Entregada',
  CANCELLED: 'Cancelada'
};

let workOrder = null;
let usersClient: { id: string; name: string | null; email: string | null }[] = [];
let usersDoctor: { id: string; name: string | null; email: string | null }[] = [];
let clinics: { id: string; name: string }[] = [];
let labs: { id: string; name: string }[] = [];

if (!isNew) {
  workOrder = await getWorkOrderById(workOrderId, user);
  if (!workOrder) {
    return new Response('Orden no encontrada', { status: 404 });
  }
  // Fetch invoices for this order
  const { data: invoices = [] } = await supabaseAdmin
    .from('invoices')
    .select('id,status')
    .eq('workOrderId', workOrder.id);
  (workOrder as any).invoices = invoices ?? [];
} else {
  const [
    { data: userClients = [] },
    { data: userDentists = [] },
    { data: clinicRows = [] },
    { data: labRows = [] }
  ] = await Promise.all([
    supabaseAdmin
      .from('user_profiles')
      .select('id,name,email')
      .eq('role', 'CLIENT')
      .order('name', { ascending: true }),
    supabaseAdmin
      .from('user_profiles')
      .select('id,name,email')
      .eq('role', 'DENTIST')
      .order('name', { ascending: true }),
    supabaseAdmin.from('clinics').select('id,name').order('name', { ascending: true }),
    supabaseAdmin.from('labs').select('id,name').order('name', { ascending: true })
  ]);

  usersClient = userClients ?? [];
  usersDoctor = userDentists ?? [];
  clinics = clinicRows ?? [];
  labs = labRows ?? [];
}
---

<AppLayout
  title={isNew ? 'Nueva orden' : workOrder!.displayCode ?? workOrder!.code}
  description={isNew ? 'Genera una nueva orden de trabajo' : 'Detalle y seguimiento'}
  user={user}
>
  {isNew ? (
    <div class="mx-auto max-w-3xl rounded-3xl border border-white/10 bg-slate-950/70 p-6 shadow-lg shadow-primary/5">
      <h2 class="text-lg font-semibold text-white">Crear nueva orden</h2>
      <p class="mt-2 text-sm text-slate-400">
        Completa los datos para generar una orden. Podrás adjuntar archivos y agregar eventos una vez creada.
      </p>
      <form id="work-order-create-form" method="post" action="/api/work-orders" class="mt-6 space-y-5">
        <div class="relative" data-patient-chooser>
          <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
            <span>Paciente</span>
            <input
              id="patientSearch"
              type="text"
              autocomplete="off"
              placeholder="Busca por nombre del paciente"
              class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-4 py-3 text-sm text-white focus:border-accent focus:outline-none"
              data-patient-search
            />
          </label>
          <input type="hidden" name="patientId" id="patientIdHidden" />
          <p class="mt-1 text-xs text-slate-400">
            Selecciona un paciente existente o escribe un nombre para crear uno nuevo.
          </p>
          <div
            id="patient-suggestions"
            class="absolute inset-x-0 z-20 mt-1 hidden max-h-56 overflow-auto rounded-xl border border-white/10 bg-slate-900/90 text-sm shadow-xl shadow-black/30"
            data-patient-suggestions
          ></div>
        </div>
        <input type="hidden" id="predefinedClientName" name="predefinedClientName" />
        <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
          <span>Fecha estimada de entrega</span>
          <input
            id="dueDate"
            name="dueDate"
            type="datetime-local"
            class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-4 py-3 text-sm text-white focus:border-accent focus:outline-none"
          />
        </label>
        <div class="grid grid-cols-1 gap-5 md:grid-cols-2">
          <div>
            <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
              <span>Cliente</span>
              <select
                id="clientId"
                name="clientId"
                class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-4 py-3 text-sm text-white focus:border-accent focus:outline-none"
              >
                <option value="">—</option>
                {databaseClients.map((client) => (
                  <option value={client.id}>{client.name}</option>
                ))}
              </select>
            </label>
            <button type="button" id="add-client-btn" class="mt-2 text-sm text-accent hover:underline">+ Agregar Nuevo Cliente</button>
          </div>
        </div>
        <div class="flex flex-col gap-2 text-sm font-medium text-slate-200">
          <span>Tipo de trabajo</span>
          <div class="grid grid-cols-2 gap-4">
            {workTypesData.map((workType, index) => (
              <div class="flex items-center gap-2">
                <input
                  type="radio"
                  name="workType"
                  value={workType}
                  id={`workType-${workType}`}
                  checked={index === 0}
                  class="w-4 h-4 text-accent bg-gray-100 border-gray-300 focus:ring-accent"
                />
                <label for={`workType-${workType}`} class="text-sm font-medium text-white cursor-pointer">{workType}</label>
              </div>
            ))}
          </div>
        </div>
        
        
        <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
          <span>Notas iniciales</span>
          <textarea
            id="notes"
            name="notes"
            rows={4}
            placeholder="Descripcion clinica, requerimientos, etc."
            class="w-full rounded-xl border border-white/10 bg-slate-900/70 px-4 py-3 text-sm text-white focus:border-accent focus:outline-none"
          />
        </label>

        {(() => {
          const err = Astro.url.searchParams.get('error');
          return err ? (
            <p class="mt-3 rounded-xl border border-red-500/20 bg-red-500/10 px-4 py-3 text-sm text-red-300">
              {err}
            </p>
          ) : null;
        })()}

        <button
          type="submit"
          class="w-full rounded-xl bg-accent px-4 py-3 text-sm font-semibold text-white transition hover:bg-accent/90"
        >
          Crear orden
        </button>
      </form>
    </div>
  ) : (
    <div class="grid gap-6 lg:grid-cols-[1.1fr_0.9fr]">
      <section class="rounded-3xl border border-white/10 bg-slate-950/70 p-6 shadow-lg shadow-primary/5">
        <h2 class="text-lg font-semibold text-white">Resumen del caso</h2>
        <dl class="mt-4 grid gap-3 text-sm text-slate-300">
          <div class="flex justify-between">
            <dt>Orden</dt>
            <dd>{workOrder!.displayCode ?? workOrder!.code}</dd>
          </div>
          <div class="flex justify-between">
            <dt>Paciente</dt>
            <dd>{workOrder!.patient?.name ?? 'Sin paciente'}</dd>
          </div>
          <div class="flex justify-between">
            <dt>Cliente</dt>
            <dd>{workOrder!.client?.name ?? workOrder!.client?.email ?? 'Sin asignar'}</dd>
          </div>
          
          <div class="flex justify-between">
            <dt>Tipo de trabajo</dt>
            <dd>{workOrder!.workType ?? 'Sin definir'}</dd>
          </div>
          
          
          <div class="flex justify-between">
            <dt>Estado</dt>
            <dd>
              <span class="rounded-full bg-white/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-white" data-status-badge>
                {statusNames[workOrder!.status] ?? workOrder!.status}
              </span>
            </dd>
          </div>
          <div class="flex justify-between">
            <dt>Entrega estimada</dt>
            <dd>
              {workOrder!.dueDate ? new Date(workOrder!.dueDate).toLocaleDateString('es-AR') : 'Sin fecha'}
            </dd>
          </div>
          {showPrice && (
            <div class="flex justify-between items-center">
              <dt>Precio</dt>
              <dd class="flex items-center gap-2">
                {userIsAdmin ? (
                  <div class="flex items-center gap-2">
                    <span>$</span>
                    <input
                      type="number"
                      id="order-price-input"
                      value={workOrder!.price?.toString() ?? '0'}
                      step="0.01"
                      min="0"
                      class="w-24 rounded-lg border border-white/10 bg-slate-900/70 px-2 py-1 text-sm text-white focus:border-accent focus:outline-none"
                      data-order-id={workOrder!.id}
                      data-original-price={workOrder!.price?.toString() ?? '0'}
                    />
                    <button
                      type="button"
                      id="save-price-btn"
                      class="hidden rounded-lg bg-accent px-3 py-1 text-xs font-semibold text-white hover:bg-accent/90"
                    >
                      Guardar
                    </button>
                  </div>
                ) : (
                  <span>${workOrder!.price?.toString() ?? '0'}</span>
                )}
              </dd>
            </div>
          )}
        </dl>
        <p id="price-feedback" class="mt-2 hidden rounded-xl border px-4 py-2 text-sm"></p>
        {userIsAdmin && (workOrder!.status === 'DONE' || workOrder!.status === 'DELIVERED') && (workOrder as any).invoices?.length === 0 && (
          <div class="mt-6">
            <button
              type="button"
              id="generate-invoice-btn"
              data-order-id={workOrder!.id}
              class="w-full rounded-xl bg-blue-500 px-4 py-3 text-sm font-semibold text-white transition hover:bg-blue-600"
            >
              Generar Factura
            </button>
            <p id="invoice-feedback" class="mt-2 hidden rounded-xl border px-4 py-2 text-sm"></p>
          </div>
        )}
        {userIsAdmin && workOrder!.status === 'DONE' && (
          <div class="mt-6">
            <button
              type="button"
              id="deliver-order-btn"
              data-order-id={workOrder!.id}
              class="w-full rounded-xl bg-emerald-500 px-4 py-3 text-sm font-semibold text-white transition hover:bg-emerald-600"
            >
              Marcar como Entregada
            </button>
            <p id="deliver-feedback" class="mt-2 hidden rounded-xl border px-4 py-2 text-sm"></p>
          </div>
        )}
        <div class="mt-6">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">Escaneos y archivos</h3>
          <ul class="mt-3 space-y-2 text-sm text-slate-200">
            {workOrder!.files.map((file) => (
              <li class="flex items-center justify-between rounded-xl border border-white/5 bg-slate-900/60 px-4 py-3">
                <span>{file.kind}</span>
                <a href={file.url} class="text-accent hover:underline" target="_blank">Descargar</a>
              </li>
            ))}
            {workOrder!.files.length === 0 && (
              <li class="rounded-xl border border-dashed border-white/10 px-4 py-3 text-sm text-slate-400">
                Sin archivos todavía. Carga un STL/OBJ/PLY para visualizar.
              </li>
            )}
          </ul>
          {allowFileUpload && (
            <div
              class="mt-4 space-y-2 rounded-2xl border border-dashed border-white/10 bg-slate-900/60 p-4"
              data-file-upload
              data-work-order-id={workOrder!.id}
            >
              <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                <label class="flex w-full flex-col gap-1 text-xs uppercase tracking-wide text-slate-400 sm:w-48">
                  <span>Tipo</span>
                  <select
                    id="file-kind"
                    class="rounded-xl border border-white/10 bg-slate-950/80 px-3 py-2 text-sm text-white focus:border-accent focus:outline-none"
                    data-file-kind
                  >
                    <option value="OTHER">Otro</option>
                    <option value="STL">STL / CAD</option>
                    <option value="SCAN">Escaneo</option>
                    <option value="PHOTO">Foto</option>
                  </select>
                </label>
                <input
                  type="file"
                  class="w-full text-sm text-slate-200 file:mr-4 file:rounded-lg file:border-0 file:bg-accent file:px-4 file:py-2 file:text-sm file:font-semibold file:text-white hover:file:bg-accent/90"
                  data-file-input
                  accept=".stl,.obj,.ply,.jpg,.jpeg,.png,.pdf"
                />
              </div>
              <p class="text-xs text-slate-400" data-file-status>
                Selecciona un archivo para generar una URL de subida segura. Máximo 200MB.
              </p>
            </div>
          )}
        </div>
      </section>
      <section class="space-y-6">
        <ModelViewer />
        <div class="rounded-3xl border border-white/10 bg-slate-950/70 p-6 shadow-lg shadow-primary/5">
          <h3 class="text-lg font-semibold text-white">Historial</h3>
          <ol class="mt-4 space-y-4">
            {workOrder!.events.map((event) => (
              <li class="rounded-2xl border border-white/5 bg-slate-900/60 p-4 text-sm text-slate-200">
                <div class="flex items-center justify-between">
                  <span class="font-medium text-white">{event.type}</span>
                  <time class="text-xs text-slate-400">{new Date(event.createdAt).toLocaleString('es-AR')}</time>
                </div>
                <p class="mt-2 text-slate-300">{event.message}</p>
              </li>
            ))}
            {workOrder!.events.length === 0 && (
              <li class="rounded-2xl border border-dashed border-white/10 p-4 text-sm text-slate-400">
                Aún no hay eventos en esta orden.
              </li>
            )}
          </ol>
        </div>
      </section>
    </div>
  )}
</AppLayout>

<script type="module" is:inline>
  const form = /** @type {HTMLFormElement | null} */ (
    document.getElementById('work-order-create-form')
  );
  const patientSearch = /** @type {HTMLInputElement | null} */ (
    document.querySelector('[data-patient-search]')
  );
  const patientIdInput = /** @type {HTMLInputElement | null} */ (
    document.getElementById('patientIdHidden')
  );
  const suggestionsBox = /** @type {HTMLDivElement | null} */ (
    document.querySelector('[data-patient-suggestions]')
  );
  const submitBtn = form ? form.querySelector('button[type="submit"]') : null;
  let suggestionAbort = 0;

  if (form && patientSearch && patientIdInput && suggestionsBox && submitBtn) {
    const hideSuggestions = () => {
      suggestionsBox.innerHTML = '';
      suggestionsBox.classList.add('hidden');
    };

    const applySuggestion = (id, label) => {
      patientSearch.value = label;
      patientIdInput.value = id;
      hideSuggestions();
    };

    const renderSuggestions = (items) => {
      if (items.length === 0) {
        hideSuggestions();
        return;
      }
      suggestionsBox.innerHTML = '';
      items.forEach((item) => {
        const option = document.createElement('button');
        option.type = 'button';
        option.textContent = item.name;
        option.className =
          'block w-full px-4 py-2 text-left text-sm text-white hover:bg-accent/20 focus:bg-accent/30';
        option.addEventListener('click', () => applySuggestion(item.id, item.name));
        suggestionsBox.appendChild(option);
      });
      suggestionsBox.classList.remove('hidden');
    };

    const searchPatients = async (query) => {
      if (query.length < 2) {
        hideSuggestions();
        return;
      }
      const ticket = ++suggestionAbort;
      try {
        const response = await fetch(`/api/patients/search?q=${encodeURIComponent(query)}`);
        if (!response.ok) return;
        if (ticket !== suggestionAbort) return;
        const data = await response.json();
        renderSuggestions(data?.patients ?? []);
      } catch (error) {
        console.error('Patient search failed', error);
      }
    };

    let debounceHandle;
    patientSearch.addEventListener('input', (event) => {
      if (!(event.target instanceof HTMLInputElement)) return;
      const value = event.target.value;
      patientIdInput.value = value;
      window.clearTimeout(debounceHandle);
      debounceHandle = window.setTimeout(() => searchPatients(value.trim()), 200);
    });

    document.addEventListener('click', (event) => {
      if (!(event.target instanceof Node)) return;
      if (!event.target.closest('[data-patient-chooser]')) {
        hideSuggestions();
      }
    });

    form.addEventListener('submit', () => {
      if (!patientIdInput.value) {
        patientIdInput.value = patientSearch.value.trim();
      }
      submitBtn.setAttribute('disabled', 'true');
      submitBtn.textContent = 'Creando...';
    });

    const params = new URLSearchParams(window.location.search);
    if (params.has('error')) {
      submitBtn.removeAttribute('disabled');
      submitBtn.textContent = 'Crear orden';
    }
  }

  const addClientBtn = document.getElementById('add-client-btn');
  const clientIdSelect = document.getElementById('clientId');
  const predefinedClientInput = document.getElementById('predefinedClientName');

  if (clientIdSelect && predefinedClientInput) {
    const ensureCustomOption = (label) => {
      const existing = clientIdSelect.querySelector('option[data-custom="true"]');
      if (existing) {
        existing.textContent = label;
        existing.selected = true;
        existing.value = '';
        return existing;
      }
      const option = document.createElement('option');
      option.dataset.custom = 'true';
      option.value = '';
      option.textContent = label;
      option.selected = true;
      clientIdSelect.appendChild(option);
      return option;
    };

    clientIdSelect.addEventListener('change', (event) => {
      if (!(event.target instanceof HTMLSelectElement)) return;
      const selected = event.target.selectedOptions[0] ?? null;
      const value = selected?.value.trim() ?? '';
      const isCustom = selected?.dataset.custom === 'true';
      if (value) {
        predefinedClientInput.value = '';
        const existing = clientIdSelect.querySelector('option[data-custom="true"]');
        if (existing) existing.remove();
        return;
      }
      if (!isCustom) {
        predefinedClientInput.value = '';
        const existing = clientIdSelect.querySelector('option[data-custom="true"]');
        if (existing) existing.remove();
      }
    });

    if (addClientBtn) {
      addClientBtn.addEventListener('click', () => {
        const name = prompt('Ingrese el nombre del nuevo cliente:');
        const trimmed = name ? name.trim() : '';
        if (!trimmed) return;
        predefinedClientInput.value = trimmed;
        ensureCustomOption(trimmed);
      });
    }
  }

  // Botón de generar factura (solo admin)
  const invoiceBtn = document.getElementById('generate-invoice-btn');
  const invoiceFeedback = document.getElementById('invoice-feedback');

  if (invoiceBtn instanceof HTMLButtonElement) {
    invoiceBtn.addEventListener('click', async () => {
      const orderId = invoiceBtn.dataset.orderId;
      if (!orderId) return;

      invoiceBtn.disabled = true;
      invoiceBtn.textContent = 'Generando...';
      if (invoiceFeedback) {
        invoiceFeedback.classList.add('hidden');
      }

      try {
        const response = await fetch(`/api/billing/invoices`, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ orderId })
        });
        const data = await response.json().catch(() => ({}));

        if (!response.ok || !data?.ok) {
          throw new Error(data?.error ?? 'No se pudo generar la factura');
        }

        if (invoiceFeedback) {
          invoiceFeedback.textContent = '✓ Factura generada correctamente';
          invoiceFeedback.classList.remove('hidden', 'border-red-500/20', 'bg-red-500/10', 'text-red-200');
          invoiceFeedback.classList.add('border-emerald-500/20', 'bg-emerald-500/10', 'text-emerald-200');
        }

        invoiceBtn.style.display = 'none';
        setTimeout(() => window.location.reload(), 2000);
      } catch (error) {
        console.error('Error al generar factura', error);
        if (invoiceFeedback) {
          invoiceFeedback.textContent = error instanceof Error ? error.message : 'Error al generar la factura';
          invoiceFeedback.classList.remove('hidden', 'border-emerald-500/20', 'bg-emerald-500/10', 'text-emerald-200');
          invoiceFeedback.classList.add('border-red-500/20', 'bg-red-500/10', 'text-red-200');
        }
        invoiceBtn.disabled = false;
        invoiceBtn.textContent = 'Generar Factura';
      }
    });
  }

  // Botón de entregar orden (solo admin)
  const deliverBtn = document.getElementById('deliver-order-btn');
  const deliverFeedback = document.getElementById('deliver-feedback');
  const statusBadge = document.querySelector('[data-status-badge]');

  if (deliverBtn instanceof HTMLButtonElement) {
    deliverBtn.addEventListener('click', async () => {
      const orderId = deliverBtn.dataset.orderId;
      if (!orderId) return;

      deliverBtn.disabled = true;
      deliverBtn.textContent = 'Entregando...';
      if (deliverFeedback) {
        deliverFeedback.classList.add('hidden');
      }

      try {
        const response = await fetch(`/api/work-orders/${orderId}/deliver`, {
          method: 'POST',
          headers: { 'content-type': 'application/json' }
        });
        const data = await response.json().catch(() => ({}));

        if (!response.ok || !data?.ok) {
          throw new Error(data?.error ?? 'No se pudo marcar la orden como entregada');
        }

        if (statusBadge) {
          statusBadge.textContent = 'Entregada';
        }

        if (deliverFeedback) {
          deliverFeedback.textContent = '✓ Orden marcada como entregada correctamente';
          deliverFeedback.classList.remove('hidden', 'border-red-500/20', 'bg-red-500/10', 'text-red-200');
          deliverFeedback.classList.add('border-emerald-500/20', 'bg-emerald-500/10', 'text-emerald-200');
        }

        deliverBtn.style.display = 'none';
        setTimeout(() => window.location.reload(), 2000);
      } catch (error) {
        console.error('Error al entregar orden', error);
        if (deliverFeedback) {
          deliverFeedback.textContent = error instanceof Error ? error.message : 'Error al entregar la orden';
          deliverFeedback.classList.remove('hidden', 'border-emerald-500/20', 'bg-emerald-500/10', 'text-emerald-200');
          deliverFeedback.classList.add('border-red-500/20', 'bg-red-500/10', 'text-red-200');
        }
        deliverBtn.disabled = false;
        deliverBtn.textContent = 'Marcar como Entregada';
      }
    });
  }

  // Edición de precio (solo admin)
  const priceInput = document.getElementById('order-price-input');
  const savePriceBtn = document.getElementById('save-price-btn');
  const priceFeedback = document.getElementById('price-feedback');

  if (priceInput instanceof HTMLInputElement && savePriceBtn instanceof HTMLButtonElement) {
    priceInput.addEventListener('input', () => {
      const originalPrice = priceInput.dataset.originalPrice || '0';
      const currentPrice = priceInput.value;

      if (currentPrice !== originalPrice) {
        savePriceBtn.classList.remove('hidden');
      } else {
        savePriceBtn.classList.add('hidden');
      }
    });

    savePriceBtn.addEventListener('click', async () => {
      const orderId = priceInput.dataset.orderId;
      const newPrice = parseFloat(priceInput.value);

      if (!orderId || isNaN(newPrice) || newPrice < 0) {
        if (priceFeedback) {
          priceFeedback.textContent = 'Precio inválido';
          priceFeedback.classList.remove('hidden', 'border-emerald-500/20', 'bg-emerald-500/10', 'text-emerald-200');
          priceFeedback.classList.add('border-red-500/20', 'bg-red-500/10', 'text-red-200');
        }
        return;
      }

      savePriceBtn.disabled = true;
      savePriceBtn.textContent = 'Guardando...';

      try {
        const response = await fetch(`/api/work-orders/${orderId}`, {
          method: 'PATCH',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ price: newPrice })
        });

        const data = await response.json().catch(() => ({}));

        if (!response.ok || !data?.ok) {
          throw new Error(data?.error ?? 'No se pudo actualizar el precio');
        }

        if (priceFeedback) {
          priceFeedback.textContent = '✓ Precio actualizado correctamente';
          priceFeedback.classList.remove('hidden', 'border-red-500/20', 'bg-red-500/10', 'text-red-200');
          priceFeedback.classList.add('border-emerald-500/20', 'bg-emerald-500/10', 'text-emerald-200');
        }

        priceInput.dataset.originalPrice = newPrice.toString();
        savePriceBtn.classList.add('hidden');
        savePriceBtn.disabled = false;
        savePriceBtn.textContent = 'Guardar';

        setTimeout(() => {
          if (priceFeedback) {
            priceFeedback.classList.add('hidden');
          }
        }, 3000);
      } catch (error) {
        console.error('Error al actualizar precio', error);
        if (priceFeedback) {
          priceFeedback.textContent = error instanceof Error ? error.message : 'Error al actualizar el precio';
          priceFeedback.classList.remove('hidden', 'border-emerald-500/20', 'bg-emerald-500/10', 'text-emerald-200');
          priceFeedback.classList.add('border-red-500/20', 'bg-red-500/10', 'text-red-200');
        }
        savePriceBtn.disabled = false;
        savePriceBtn.textContent = 'Guardar';
      }
    });
  }

  // File upload functionality
  const uploadContainer = document.querySelector('[data-file-upload]');
  if (uploadContainer) {
    const fileKindSelect = uploadContainer.querySelector('[data-file-kind]');
    const fileInput = uploadContainer.querySelector('[data-file-input]');
    const fileStatus = uploadContainer.querySelector('[data-file-status]');
    const orderId = uploadContainer.dataset.workOrderId;

    if (fileKindSelect && fileInput && fileStatus && orderId) {
      fileInput.addEventListener('change', async () => {
        const file = fileInput.files?.[0];
        if (!file) return;

        const kind = fileKindSelect.value;
        fileStatus.textContent = 'Generando URL de subida...';

        try {
          const response = await fetch('/api/work-orders/upload-url', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({
              workOrderId: orderId,
              filename: file.name,
              contentType: file.type || 'application/octet-stream',
              kind
            })
          });

          if (!response.ok) {
            throw new Error('No se pudo generar la URL de subida');
          }

          const data = await response.json();
          fileStatus.textContent = `Subiendo ${file.name}...`;

          const uploadResponse = await fetch(data.uploadUrl, {
            method: 'PUT',
            headers: { 'Content-Type': file.type || 'application/octet-stream' },
            body: file
          });

          if (!uploadResponse.ok) {
            throw new Error('Error al subir el archivo');
          }

          fileStatus.textContent = '✓ Archivo subido correctamente. Recargando...';
          setTimeout(() => window.location.reload(), 1500);
        } catch (error) {
          console.error('Upload error', error);
          fileStatus.textContent = error instanceof Error ? error.message : 'Error al subir archivo';
        }
      });
    }
  }
</script>
